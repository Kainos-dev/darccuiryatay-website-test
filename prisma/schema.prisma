// prisma/schema.prisma
generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "mongodb"
    url      = env("MONGODB_URI")
}

enum Role {
    admin
    minorista
    mayorista
}

// ******************************** USER ******************************** //

model User {
    id String @id @default(auto()) @map("_id") @db.ObjectId

    firstName String
    lastName  String
    email     String  @unique
    password  String?

    phone     String? // Solo mayorista
    localidad String? // Solo mayorista
    storeName String? // Solo mayorista

    role Role @default(minorista)

    cart Cart?

    emailVerified DateTime?

    verificationToken       String?
    verificationTokenExpiry DateTime?

    resetToken       String?
    resetTokenExpiry DateTime?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    orders    Order[]

    @@map("users")
}

model Cart {
    id String @id @default(auto()) @map("_id") @db.ObjectId

    // userId ahora es OPCIONAL (para carritos an√≥nimos)
    userId String? @unique @db.ObjectId
    user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    // NUEVO: Para identificar carritos an√≥nimos
    sessionId String? 

    items CartItem[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // √çndice para limpiar carritos viejos
    @@index([createdAt])
    @@map("carts")
}

model CartItem {
    id String @id @default(auto()) @map("_id") @db.ObjectId

    // Relaci√≥n con Product
    productId String  @db.ObjectId
    product   Product @relation(fields: [productId], references: [id])

    quantity Int

    // ‚úÖ NUEVO: Soporte para variantes
    variantColor String? // "Rojo", "Azul", etc.
    variantHex   String? // "#FF0000", "#0000FF"

    // Relaci√≥n N:1 con Cart
    cartId String @db.ObjectId
    cart   Cart   @relation(fields: [cartId], references: [id], onDelete: Cascade)

    @@map("cart_items")
}

/**
 * ## üéØ Flujo de Datos
 * ```
 * User (id: "user123")
 * ‚îî‚îÄ Cart (userId: "user123")
 * ‚îú‚îÄ CartItem (productId: "prod1", quantity: 2)
 * ‚îú‚îÄ CartItem (productId: "prod2", quantity: 1)
 * ‚îî‚îÄ CartItem (productId: "prod3", quantity: 5)
 */

// ******************************** PRODUCTS ******************************** //

enum Rubro {
    darccuir
    yatay
}

enum StockStatus {
    DISPONIBLE
    SIN_STOCK
    CONSULTAR
}

model Product {
    id             String   @id @default(auto()) @map("_id") @db.ObjectId
    sku            String   @unique
    name           String
    price          Float
    priceWholesale Float?
    coverImages    String[] // URLs de Cloudinary
    variants       Json // Array de objetos { color: { name, hex }, images: [] }
    description    String?
    guiaTalles     String? // URL de imagen de gu√≠a de talles (opcional)
    rubro          Rubro // "darccuir" o "yatay"
    subrubros      String[] // Array de IDs de subrubros

    // Campos √∫tiles para administraci√≥n
    active    Boolean     @default(true)
    stock     StockStatus @default(DISPONIBLE)
    createdAt DateTime    @default(now())
    updatedAt DateTime    @updatedAt
    cartItems CartItem[]

    @@map("products")
}

// Modelo separado para Subrubros (permite jerarqu√≠a)
model Subrubro {
    id       String     @id @default(auto()) @map("_id") @db.ObjectId
    name     String
    slug     String
    parentId String?    @db.ObjectId // Para crear jerarqu√≠a
    parent   Subrubro?  @relation("SubrubroHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
    children Subrubro[] @relation("SubrubroHierarchy")

    rubro  Rubro // A qu√© rubro principal pertenece
    order  Int     @default(0) // Para ordenar en UI
    active Boolean @default(true)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([slug, rubro]) // <<--- UNIQUE por rubro + slug
    @@unique([name, rubro])
    @@map("subrubros")
}

// Modelo para gestionar los locales de clientes
model Local {
    id         String  @id @default(auto()) @map("_id") @db.ObjectId
    nroCliente String  @unique @map("nro_cliente")
    nombre     String
    provincia  String
    localidad  String
    ubicacion  String? // Direcci√≥n f√≠sica (opcional)
    linkGmaps  String? @map("link_gmaps") // Link de Google Maps (opcional)
    redSocial  String? @map("red_social") // Link de red social (opcional)
    imagenUrl  String? @map("imagen_url") // URL de la imagen del local (opcional)

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@index([provincia])
    @@index([localidad])
    @@map("locales")
}

// Opcional: Modelo para trackear cambios de precio
/**
 * model PriceHistory {
 * id        String   @id @default(auto()) @map("_id") @db.ObjectId
 * productId String   @db.ObjectId
 * sku       String
 * oldPrice  Float
 * newPrice  Float
 * changedBy String // Email del admin
 * changedAt DateTime @default(now())
 * @@map("price_history")
 * }
 */

//** ORDERS

enum OrderStatus {
    PENDIENTE // Orden recibida, esperando confirmaci√≥n
    CONFIRMADO // Confirmado por el admin
    EN_PREPARACION // Preparando el pedido
    ENVIADO // Pedido enviado
    ENTREGADO // Pedido entregado
    CANCELADO // Cancelado
}

model Order {
    id String @id @default(auto()) @map("_id") @db.ObjectId

    // N√∫mero de orden
    orderNumber String @unique

    // Relaci√≥n con usuario (opcional)
    userId String? @db.ObjectId
    user   User?   @relation(fields: [userId], references: [id])

    // Datos del cliente
    customerName  String
    customerEmail String
    customerPhone String?

    // Direcci√≥n de env√≠o
    shippingAddress Json

    // Items
    items OrderItem[]

    // Totales
    subtotal Float
    shipping Float @default(0)
    total    Float

    // Estado
    status            OrderStatus @default(PENDIENTE)
    estimatedDelivery String?

    // Notas
    notes      String?
    adminNotes String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([customerEmail])
    @@index([status])
    @@index([createdAt])
    @@map("orders")
}

model OrderItem {
    id String @id @default(auto()) @map("_id") @db.ObjectId

    orderId String @db.ObjectId
    order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

    // Datos del producto (guardados en el momento de la compra)
    productId   String @db.ObjectId
    productName String
    productSku  String
    price       Float // Precio al momento de la compra

    // Variante si aplica
    variantColor String?
    variantHex   String?

    quantity Int

    // Subtotal de este item
    subtotal Float // price * quantity

    @@map("order_items")
}

// Agregar esta relaci√≥n al modelo User existente:
// orders Order[]
